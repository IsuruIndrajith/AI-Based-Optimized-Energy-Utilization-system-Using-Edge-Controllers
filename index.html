<!-- Save as index.html in your HTTP server root -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Appliance ON/OFF Schedules</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; }
    .chart-container { width: 90vw; height: 200px; margin-bottom: 40px; }
    h3 { margin-bottom: 0; }
  </style>
</head>
<body>
  <h2>Optimised Appliance Schedules (24-hour ON/OFF)</h2>
  <div id="charts"></div>
  <script>
    const colors = [
      'rgba(255,99,132,0.7)',
      'rgba(54,162,235,0.7)',
      'rgba(255,206,86,0.7)',
      'rgba(75,192,192,0.7)',
      'rgba(153,102,255,0.7)'
    ];
    let chartObjs = {};

    function parseOutputTxt(text) {
      const lines = text.split('\n');
      const labels = Array.from({length: 24}, (_, i) => i + ":00");
      const appliances = [];
      let current = null;
      for (let line of lines) {
        if (line.startsWith('---')) {
          current = { label: line.replace(/---|\s/g, ''), data: [] };
        } else if (line.startsWith('States:')) {
          const arr = line.match(/\[(.*?)\]/)[1].split(',').map(x => Number(x.trim()));
          current.data = arr;
          appliances.push(current);
        }
      }
      return { labels, appliances };
    }

    async function updateCharts() {
      const resp = await fetch('output.txt?' + Date.now());
      const text = await resp.text();
      const { labels, appliances } = parseOutputTxt(text);

      const chartsDiv = document.getElementById('charts');
      chartsDiv.innerHTML = ''; // Clear previous charts

      appliances.forEach((appliance, i) => {
        // Create container and canvas for each appliance
        const container = document.createElement('div');
        container.className = 'chart-container';
        const title = document.createElement('h3');
        title.textContent = appliance.label;
        const canvas = document.createElement('canvas');
        canvas.id = 'chart_' + appliance.label;

        container.appendChild(title);
        container.appendChild(canvas);
        chartsDiv.appendChild(container);

        // Draw chart
        const ctx = canvas.getContext('2d');
        if (chartObjs[appliance.label]) {
          chartObjs[appliance.label].destroy();
        }
        chartObjs[appliance.label] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: appliance.label,
              data: appliance.data,
              backgroundColor: colors[i % colors.length],
              borderColor: colors[i % colors.length],
              barPercentage: 0.8,
              categoryPercentage: 0.8,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: false }
            },
            scales: {
              x: { },
              y: {
                min: 0,
                max: 1,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      });
    }

    updateCharts();
    setInterval(updateCharts, 30000); // update every 30 seconds
  </script>
</body>
</html>